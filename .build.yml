image: debian/stable
secrets:
    - a475799b-9aad-407d-b005-4a06a6ef6a2a
packages:
    - curl
    - apt-transport-https
    - ca-certificates
    - curl
    - gnupg2
    - software-properties-common
sources:
    - https://git.sr.ht/~uknth/faker
tasks:
    - docker_install: | 
        curl -fsSL https://download.docker.com/linux/debian/gpg | sudo apt-key add -
        sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/debian $(lsb_release -cs) stable"
        sudo apt-get update
        sudo apt-get install -y docker-ce docker-ce-cli containerd.io
    - go_install: |
        wget -q https://dl.google.com/go/go1.12.linux-amd64.tar.gz
        sudo tar -C /usr/local -xzf go1.12.linux-amd64.tar.gz
        sudo ln -s /usr/local/go/bin/go /usr/bin/go
        go env
    - dep_install: |
        mkdir -p $HOME/go/bin
        curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
        sudo ln -s /home/build/go/bin/dep /usr/bin/dep
    - src_copy: | 
        mkdir -p $HOME/go/src/git.sr.ht/~uknth
        mv faker $HOME/go/src/git.sr.ht/~uknth
    - dep_ensure: |
        cd $HOME/go/src/git.sr.ht/~uknth/faker
        dep ensure -v
    - test: |
        go test -v git.sr.ht/~uknth/faker
    - docker_login: |
        source $HOME/.docker-credential
    - docker_build: |
        docker build -t faker:latest . 
    - docker_test: |
        docker run -p12000:12000 -d faker:latest
        docker ps -a
        curl -v "http://127.0.0.1:12000/ping?q=*&fields=uniqueId"
    - docker_push: |
        ./scripts/push-to-dockerhub.sh 
triggers:
    - action: email
      condition: always
      to: uknth@outlook.com
